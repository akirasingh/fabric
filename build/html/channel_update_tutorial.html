
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adding an Org to a Channel &#8212; hyperledger-fabricdocs master documentation</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Updating a channel configuration" href="config_update.html" />
    <link rel="prev" title="Channel policies" href="create_channel/channel_policies.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="index.html">
    
      <p class="title">hyperledger-fabricdocs</p>
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="intro.html">Introduction</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="whatsnew.html">What’s new in Hyperledger Fabric v2.x</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href=""></a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="key_concepts.html">Key Concepts</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="getting_started.html">Getting Started - Install</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="getting_started_run_fabric.html">Getting Started - Run Fabric</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="developapps/developing_applications.html">Developing Applications</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="tutorials.html">Tutorials</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="deployment_guide_overview.html">Deploying a production network</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="ops_guide.html">Operations Guides</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="upgrade.html">Upgrading to the latest release</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="command_ref.html">Commands Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="architecture.html">Architecture Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="Fabric-FAQ.html">Frequently Asked Questions</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="CONTRIBUTING.html">Contributions Welcome!</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="glossary.html">Glossary</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="releases.html">Releases</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="questions.html">Still Have Questions?</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="status.html">Status</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="test_network.html">Using the Fabric test network</a>
                </li>
            
          
            
                <li class="">
                    <a href="deploy_chaincode.html">Deploying a smart contract to a channel</a>
                </li>
            
          
            
                <li class="">
                    <a href="write_first_app.html">Running a Fabric Application</a>
                </li>
            
          
            
                <li class="">
                    <a href="tutorial/commercial_paper.html">Commercial paper tutorial</a>
                </li>
            
          
            
                <li class="">
                    <a href="private_data_tutorial.html">Using Private Data in Fabric</a>
                </li>
            
          
            
                <li class="">
                    <a href="secured_asset_transfer/secured_private_asset_transfer_tutorial.html">Secured asset transfer in Fabric</a>
                </li>
            
          
            
                <li class="">
                    <a href="couchdb_tutorial.html">Using CouchDB</a>
                </li>
            
          
            
                <li class="">
                    <a href="create_channel/create_channel_overview.html">Creating a channel</a>
                </li>
            
          
            
                <li class="active">
                    <a href="">Adding an Org to a Channel</a>
                </li>
            
          
            
                <li class="">
                    <a href="config_update.html">Updating a channel configuration</a>
                </li>
            
          
            
                <li class="">
                    <a href="chaincode4ade.html">Writing Your First Chaincode</a>
                </li>
            
          
            
                <li class="">
                    <a href="peer-chaincode-devmode.html">Running chaincode in development mode</a>
                </li>
            
          
            
                <li class="">
                    <a href="videos.html">Videos</a>
                </li>
            
          
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#setup-the-environment" class="nav-link">Setup the Environment</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#bring-org3-into-the-channel-with-the-script" class="nav-link">Bring Org3 into the Channel with the Script</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#bring-org3-into-the-channel-manually" class="nav-link">Bring Org3 into the Channel Manually</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#generate-the-org3-crypto-material" class="nav-link">Generate the Org3 Crypto Material</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#bring-up-org3-components" class="nav-link">Bring up Org3 components</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#fetch-the-configuration" class="nav-link">Fetch the Configuration</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#convert-the-configuration-to-json-and-trim-it-down" class="nav-link">Convert the Configuration to JSON and Trim It Down</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#add-the-org3-crypto-material" class="nav-link">Add the Org3 Crypto Material</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#sign-and-submit-the-config-update" class="nav-link">Sign and Submit the Config Update</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#join-org3-to-the-channel" class="nav-link">Join Org3 to the Channel</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#configuring-leader-election" class="nav-link">Configuring Leader Election</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#install-define-and-invoke-chaincode" class="nav-link">Install, define, and invoke chaincode</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#conclusion" class="nav-link">Conclusion</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#updating-the-channel-config-to-include-an-org3-anchor-peer-optional" class="nav-link">Updating the Channel Config to include an Org3 Anchor Peer (Optional)</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="adding-an-org-to-a-channel">
<h1>Adding an Org to a Channel<a class="headerlink" href="#adding-an-org-to-a-channel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that you have downloaded the appropriate images and binaries
as outlined in <a class="reference internal" href="install.html"><span class="doc">Install Fabric and Fabric Samples</span></a> and <a class="reference internal" href="prereqs.html"><span class="doc">Prerequisites</span></a> that conform to the
version of this documentation (which can be found at the bottom of the
table of contents to the left).</p>
</div>
<p>This tutorial extends the Fabric test network by adding a new organization
– Org3 – to an application channel.</p>
<p>While we will focus on adding a new organization to the channel, you can use a
similar process to make other channel configuration updates (updating modification
policies or altering batch size, for example). To learn more about the process
and possibilities of channel config updates in general, check out <a class="reference internal" href="config_update.html"><span class="doc">Updating a channel configuration</span></a>).
It’s also worth noting that channel configuration updates like the one
demonstrated here will usually be the responsibility of an organization admin
(rather than a chaincode or application developer).</p>
<div class="section" id="setup-the-environment">
<h2>Setup the Environment<a class="headerlink" href="#setup-the-environment" title="Permalink to this headline">¶</a></h2>
<p>We will be operating from the root of the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> subdirectory within
your local clone of <code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code>. Change into that directory now.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> fabric-samples/test-network
</pre></div>
</div>
<p>First, use the <code class="docutils literal notranslate"><span class="pre">network.sh</span></code> script to tidy up. This command will kill any active
or stale Docker containers and remove previously generated artifacts. It is by no
means <strong>necessary</strong> to bring down a Fabric network in order to perform channel
configuration update tasks. However, for the sake of this tutorial, we want to operate
from a known initial state. Therefore let’s run the following command to clean up any
previous environments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./network.sh down
</pre></div>
</div>
<p>You can now use the script to bring up the test network with one channel named
<code class="docutils literal notranslate"><span class="pre">channel1</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./network.sh up createChannel -c channel1
</pre></div>
</div>
<p>If the command was successful, you can see the following message printed in your
logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Channel <span class="s1">&#39;channel1&#39;</span> joined
</pre></div>
</div>
<p>Now that you have a clean version of the test network running on your machine, we
can start the process of adding a new org to the channel we created. First, we are
going use a script to add Org3 to the channel to confirm that the process works.
Then, we will go through the step by step process of adding Org3 by updating the
channel configuration.</p>
</div>
<div class="section" id="bring-org3-into-the-channel-with-the-script">
<h2>Bring Org3 into the Channel with the Script<a class="headerlink" href="#bring-org3-into-the-channel-with-the-script" title="Permalink to this headline">¶</a></h2>
<p>You should be in the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory. To use the script, simply issue
the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> addOrg3
./addOrg3.sh up -c channel1
</pre></div>
</div>
<p>The output here is well worth reading. You’ll see the Org3 crypto material being
generated, the Org3 organization definition being created, and then the channel
configuration being updated, signed, and then submitted to the channel.</p>
<p>If everything goes well, you’ll get this message:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Org3 peer successfully added to network
</pre></div>
</div>
<p>Now that we have confirmed we can add Org3 to our channel, we can go through the
steps to update the channel configuration that the script completed behind the
scenes.</p>
</div>
<div class="section" id="bring-org3-into-the-channel-manually">
<h2>Bring Org3 into the Channel Manually<a class="headerlink" href="#bring-org3-into-the-channel-manually" title="Permalink to this headline">¶</a></h2>
<p>If you just used the <code class="docutils literal notranslate"><span class="pre">addOrg3.sh</span></code> script, you’ll need to bring your network down.
The following command will bring down all running components and remove the crypto
material for all organizations:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ..
./network.sh down
</pre></div>
</div>
<p>After the network is brought down, bring it back up again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./network.sh up createChannel -c channel1
</pre></div>
</div>
<p>This will bring your network back to the same state it was in before you executed
the <code class="docutils literal notranslate"><span class="pre">addOrg3.sh</span></code> script.</p>
<p>Now we’re ready to add Org3 to the channel manually. As a first step, we’ll need
to generate Org3’s crypto material.</p>
</div>
<div class="section" id="generate-the-org3-crypto-material">
<h2>Generate the Org3 Crypto Material<a class="headerlink" href="#generate-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<p>In another terminal, change into the <code class="docutils literal notranslate"><span class="pre">addOrg3</span></code> subdirectory from
<code class="docutils literal notranslate"><span class="pre">test-network</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> addOrg3
</pre></div>
</div>
<p>First, we are going to create the certificates and keys for the Org3 peer, along
with an application and admin user. Because we are updating an example channel,
we are going to use the cryptogen tool instead of using a Certificate Authority.
The following command uses cryptogen  to read the <code class="docutils literal notranslate"><span class="pre">org3-crypto.yaml</span></code> file
and generate the Org3 crypto material in a new <code class="docutils literal notranslate"><span class="pre">org3.example.com</span></code> folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>../../bin/cryptogen generate --config<span class="o">=</span>org3-crypto.yaml --output<span class="o">=</span><span class="s2">&quot;../organizations&quot;</span>
</pre></div>
</div>
<p>You can find the generated Org3 crypto material alongside the certificates and
keys for Org1 and Org2 in the <code class="docutils literal notranslate"><span class="pre">test-network/organizations/peerOrganizations</span></code>
directory.</p>
<p>Once we have created the Org3 crypto material, we can use the configtxgen
tool to print out the Org3 organization definition. We will preface the command
by telling the tool to look in the current directory for the <code class="docutils literal notranslate"><span class="pre">configtx.yaml</span></code>
file that it needs to ingest.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span>
../../bin/configtxgen -printOrg Org3MSP &gt; ../organizations/peerOrganizations/org3.example.com/org3.json
</pre></div>
</div>
<p>The above command creates a JSON file – <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – and writes it to the
<code class="docutils literal notranslate"><span class="pre">test-network/organizations/peerOrganizations/org3.example.com</span></code> folder. The
organization definition contains the policy definitions for Org3, the NodeOU definitions
for Org3, and two important certificates encoded in base64 format:</p>
<blockquote>
<div><ul class="simple">
<li><p>a CA root cert, used to establish the organizations root of trust</p></li>
<li><p>a TLS root cert, used by the gossip protocol to identify Org3 for block dissemination and service discovery</p></li>
</ul>
</div></blockquote>
<p>We will add Org3 to the channel by appending this organization definition to
the channel configuration.</p>
</div>
<div class="section" id="bring-up-org3-components">
<h2>Bring up Org3 components<a class="headerlink" href="#bring-up-org3-components" title="Permalink to this headline">¶</a></h2>
<p>After we have created the Org3 certificate material, we can now bring up the
Org3 peer. From the <code class="docutils literal notranslate"><span class="pre">addOrg3</span></code> directory, issue the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-compose -f docker/docker-compose-org3.yaml up -d
</pre></div>
</div>
<p>If the command is successful, you will see the creation of the Org3 peer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Creating peer0.org3.example.com ... <span class="k">done</span>
</pre></div>
</div>
<p>This Docker Compose file has been configured to bridge across our initial network,
so that the Org3 peer resolves with the existing peers and ordering
node of the test network.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>the <cite>./addOrg3.sh up</cite> command uses a <cite>fabric-tools</cite> CLI container to perform
the channel configuration update process demonstrated below. This is to avoid the
<cite>jq</cite> dependency requirement for first-time users. However, it is recommended to
follow the process below directly on your local machine instead of using the unnecessary
CLI container.</p>
</div>
</div>
<div class="section" id="fetch-the-configuration">
<h2>Fetch the Configuration<a class="headerlink" href="#fetch-the-configuration" title="Permalink to this headline">¶</a></h2>
<p>Let’s go fetch the most recent config block for the channel – <code class="docutils literal notranslate"><span class="pre">channel1</span></code>.</p>
<p>The reason why we have to pull the latest version of the config is because channel
config elements are versioned. Versioning is important for several reasons. It prevents
config changes from being repeated or replayed (for instance, reverting to a channel config
with old CRLs would represent a security risk). Also it helps ensure concurrency (if you
want to remove an Org from your channel, for example, after a new Org has been added,
versioning will help prevent you from removing both Orgs, instead of just the Org you want
to remove).</p>
<p>Navigate back to the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory.</p>
<p>Because Org3 is not yet a member of the channel, we need to operate as the admin
of another organization to fetch the channel config. Because Org1 is a member of the channel, the
Org1 admin has permission to fetch the channel config from the ordering service.
Issue the following commands to operate as the Org1 admin.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../config/
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org1MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:7051
</pre></div>
</div>
<p>We can now issue the command to fetch the latest config block:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch config channel-artifacts/config_block.pb -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com -c channel1 --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>This command saves the binary protobuf channel configuration block to
<code class="docutils literal notranslate"><span class="pre">config_block.pb</span></code>. Note that the choice of name and file extension is arbitrary.
However, following a convention which identifies both the type of object being
represented and its encoding (protobuf or JSON) is recommended.</p>
<p>When you issued the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command, the following output is
displayed in your logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2021</span>-01-07 <span class="m">18</span>:46:33.687 UTC <span class="o">[</span>cli.common<span class="o">]</span> readBlock -&gt; INFO <span class="m">004</span> Received block: <span class="m">2</span>
</pre></div>
</div>
<p>This is telling us that the most recent configuration block for <code class="docutils literal notranslate"><span class="pre">channel1</span></code> is
actually block 2, <strong>NOT</strong> the genesis block. By default, the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code>
command returns the most <strong>recent</strong> configuration block for the targeted channel, which
in this case is the third block. This is because the test network script, <code class="docutils literal notranslate"><span class="pre">network.sh</span></code>, defined anchor
peers for our two organizations – <code class="docutils literal notranslate"><span class="pre">Org1</span></code> and <code class="docutils literal notranslate"><span class="pre">Org2</span></code> – in two separate channel update
transactions. As a result, we have the following configuration sequence:</p>
<blockquote>
<div><ul class="simple">
<li><p>block 0: genesis block</p></li>
<li><p>block 1: Org1 anchor peer update</p></li>
<li><p>block 2: Org2 anchor peer update</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="convert-the-configuration-to-json-and-trim-it-down">
<h2>Convert the Configuration to JSON and Trim It Down<a class="headerlink" href="#convert-the-configuration-to-json-and-trim-it-down" title="Permalink to this headline">¶</a></h2>
<p>The channel configuration block was stored in the <code class="docutils literal notranslate"><span class="pre">channel-artifacts</span></code> folder to keep
the update process separate from other artifacts. Change into the  <code class="docutils literal notranslate"><span class="pre">channel-artifacts</span></code>
folder to complete the next steps:</p>
<p>Now we will make use of the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool to decode this channel
configuration block into JSON format (which can be read and modified by humans).
We also must strip away all of the headers, metadata, creator signatures, and
so on that are irrelevant to the change we want to make. We accomplish this by
means of the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool (you will need to install the <a class="reference external" href="https://stedolan.github.io/jq/">jq tool</a> on your local machine):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json
jq .data.data<span class="o">[</span><span class="m">0</span><span class="o">]</span>.payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>This command leaves us with a trimmed down JSON object – <code class="docutils literal notranslate"><span class="pre">config.json</span></code> – which
will serve as the baseline for our config update.</p>
<p>Take a moment to open this file inside your text editor of choice (or in your
browser). Even after you’re done with this tutorial, it will be worth studying it
as it reveals the underlying configuration structure and the other kind of channel
updates that can be made. We discuss them in more detail in <a class="reference internal" href="config_update.html"><span class="doc">Updating a channel configuration</span></a>.</p>
</div>
<div class="section" id="add-the-org3-crypto-material">
<h2>Add the Org3 Crypto Material<a class="headerlink" href="#add-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The steps you’ve taken up to this point will be nearly identical no matter
what kind of config update you’re trying to make. We’ve chosen to add an
org with this tutorial because it’s one of the most complex channel
configuration updates you can attempt.</p>
</div>
<p>We’ll use the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool once more to append the Org3 configuration definition
– <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – to the channel’s application groups field, and name the output
– <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jq -s <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Application&quot;:{&quot;groups&quot;: {&quot;Org3MSP&quot;:.[1]}}}}}&#39;</span> config.json ../organizations/peerOrganizations/org3.example.com/org3.json &gt; modified_config.json
</pre></div>
</div>
<p>Now we have two JSON files of interest – <code class="docutils literal notranslate"><span class="pre">config.json</span></code> and
<code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>. The initial file contains only Org1 and Org2
material, whereas the “modified” file contains all three Orgs. At this
point it’s simply a matter of re-encoding these two JSON files and calculating
the delta.</p>
<p>First, translate <code class="docutils literal notranslate"><span class="pre">config.json</span></code> back into a protobuf called <code class="docutils literal notranslate"><span class="pre">config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb
</pre></div>
</div>
<p>Next, encode <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code> to <code class="docutils literal notranslate"><span class="pre">modified_config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> to calculate the delta between these two config
protobufs. This command will output a new protobuf binary named <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator compute_update --channel_id channel1 --original config.pb --updated modified_config.pb --output org3_update.pb
</pre></div>
</div>
<p>This new proto – <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code> – contains the Org3 definitions and high
level pointers to the Org1 and Org2 material. We are able to forgo the extensive
MSP material and modification policy information for Org1 and Org2 because this
data is already present within the channel’s genesis block. As such, we only need
the delta between the two configurations.</p>
<p>Before submitting the channel update, we need to perform a few final steps. First,
let’s decode this object into editable JSON format and call it <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input org3_update.pb --type common.ConfigUpdate --output org3_update.json
</pre></div>
</div>
<p>Now, we have a decoded update file – <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code> – that we need to wrap
in an envelope message. This step will give us back the header field that we stripped away
earlier. We’ll name this file <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;</span>channel1<span class="s1">&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;</span><span class="k">$(</span>cat org3_update.json<span class="k">)</span><span class="s1">&#39;}}}&#39;</span> <span class="p">|</span> jq . &gt; org3_update_in_envelope.json
</pre></div>
</div>
<p>Using our properly formed JSON – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code> – we will
leverage the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool one last time and convert it into the
fully fledged protobuf format that Fabric requires. We’ll name our final update
object <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input org3_update_in_envelope.json --type common.Envelope --output org3_update_in_envelope.pb
</pre></div>
</div>
</div>
<div class="section" id="sign-and-submit-the-config-update">
<h2>Sign and Submit the Config Update<a class="headerlink" href="#sign-and-submit-the-config-update" title="Permalink to this headline">¶</a></h2>
<p>Almost done!</p>
<p>We now have a protobuf binary – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code>. However, we need signatures from the requisite Admin users before the config can be written to the ledger. The modification policy (mod_policy) for our channel Application group is set to the default of “MAJORITY”, which means that we need a majority of existing org admins to sign it. Because we have only two orgs – Org1 and Org2 – and the majority of two is two, we need both of them to sign. Without both signatures, the ordering service will reject the transaction for failing to fulfill the policy.</p>
<p>First, let’s sign this update proto as Org1. Navigate back to the <code class="docutils literal notranslate"><span class="pre">test-network</span></code>
directory:</p>
<p>Remember that we exported the necessary environment variables to operate as the Org1 admin.
As a result, the following <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">signconfigtx</span></code> command will sign the update as Org1.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel signconfigtx -f channel-artifacts/org3_update_in_envelope.pb
</pre></div>
</div>
<p>The final step is to switch the container’s identity to reflect the Org2 Admin
user. We do this by exporting four environment variables specific to the Org2 MSP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Switching between organizations to sign a config transaction (or to do anything
else) is not reflective of a real-world Fabric operation. A single container
would never be mounted with an entire network’s crypto material. Rather, the
config update would need to be securely passed out-of-band to an Org2
Admin for inspection and approval.</p>
</div>
<p>Export the Org2 environment variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org2MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:9051
</pre></div>
</div>
<p>Lastly, we will issue the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">update</span></code> command. The Org2 Admin signature
will be attached to this call so there is no need to manually sign the protobuf a
second time:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The upcoming update call to the ordering service will undergo a series
of systematic signature and policy checks. As such you may find it
useful to stream and inspect the ordering node’s logs. You can issue a
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">orderer.example.com</span></code> command to display them.</p>
</div>
<p>Send the update call:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel update -f channel-artifacts/org3_update_in_envelope.pb -c channel1 -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>You should see a message similar to the following if your update has been submitted successfully:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2021</span>-01-07 <span class="m">18</span>:51:48.015 UTC <span class="o">[</span>channelCmd<span class="o">]</span> update -&gt; INFO <span class="m">002</span> Successfully submitted channel update
</pre></div>
</div>
<p>The successful channel update call returns a new block – block 3 – to all of the
peers on the channel. If you remember, blocks 0-2 are the initial channel
configurations. Block 3 serves as the most recent channel configuration with
Org3 now defined on the channel.</p>
<p>You can inspect the logs for <code class="docutils literal notranslate"><span class="pre">peer0.org1.example.com</span></code> by issuing the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker logs -f peer0.org1.example.com
</pre></div>
</div>
</div>
<div class="section" id="join-org3-to-the-channel">
<h2>Join Org3 to the Channel<a class="headerlink" href="#join-org3-to-the-channel" title="Permalink to this headline">¶</a></h2>
<p>At this point, the channel configuration has been updated to include our new
organization – Org3 – meaning that peers attached to it can now join <code class="docutils literal notranslate"><span class="pre">channel1</span></code>.</p>
<p>Export the following environment variables to operate as the Org3 Admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:11051
</pre></div>
</div>
<p>Org3 peers can join <code class="docutils literal notranslate"><span class="pre">channel1</span></code> by either the genesis block or a snapshot that is created
after Org3 has joined the channel.</p>
<p>To join by the genesis block, send a call to the ordering service asking for the genesis block of
<code class="docutils literal notranslate"><span class="pre">channel1</span></code>. As a result of the successful channel update, the ordering service
will verify that Org3 can pull the genesis block and join the channel. If Org3 had not
been successfully appended to the channel config, the ordering service would
reject this request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, you may find it useful to stream the ordering node’s logs
to reveal the sign/verify logic and policy checks.</p>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command to retrieve this block:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch <span class="m">0</span> channel-artifacts/channel1.block -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com -c channel1 --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>Notice, that we are passing a <code class="docutils literal notranslate"><span class="pre">0</span></code> to indicate that we want the first block on
the channel’s ledger; the genesis block. If we simply passed the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code> command, then we would have received block 3 – the
updated config with Org3 defined. However, we can’t begin our ledger with a
downstream block – we must start with block 0.</p>
<p>If successful, the command returned the genesis block to a file named <code class="docutils literal notranslate"><span class="pre">channel1.block</span></code>.
We can now use this block to join the peer to the channel. Issue the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">join</span></code> command and pass in the genesis block to join the Org3
peer to the channel:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel join -b channel-artifacts/channel1.block
</pre></div>
</div>
<p>To join by a snapshot, follow the instruction in <a class="reference external" href="peer_ledger_snapshot.html#taking-a-snapshot">Taking a snapshot</a>
to take a snapshot on an existing peer. The snapshot should be taken after Org3 has been added to <code class="docutils literal notranslate"><span class="pre">channel1</span></code>
to ensure that the snapshot contains the updated channel configuration including Org3.
Locate the snapshot directory, copy it to the filesystem of the new Org3 peer, and issue the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">joinbysnapshot</span></code> command using the path to the snapshot on your file system.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel joinbysnapshot --snapshotpath &lt;path to snapshot&gt;
</pre></div>
</div>
</div>
<div class="section" id="configuring-leader-election">
<h2>Configuring Leader Election<a class="headerlink" href="#configuring-leader-election" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is included as a general reference for understanding
the leader election settings when adding organizations to a network
after the initial channel configuration has completed.</p>
</div>
<p>Newly joining peers are bootstrapped with the genesis block, which does not
contain information about the organization that is being added in the channel
configuration update. Therefore new peers are not able to utilize gossip as
they cannot verify blocks forwarded by other peers from their own organization
until they get the configuration transaction which added the organization to the
channel. Newly added peers must therefore have one of the following
configurations so that they receive blocks from the ordering service:</p>
<p>1. To ensure that peers always receive blocks directly from the ordering service,
configure the peer to be an organization leader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">false</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This configuration is the default starting in Fabric v2.2 and must be the
same for all new peers added to the channel.</p>
</div>
<p>2. To eventually utilize dynamic leader election within the organization,
configure the peer to use leader election:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">true</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because peers of the newly added organization won’t initially be able to form
membership view, this option will be similar to the static
configuration, as each peer will start proclaiming itself to be a
leader. However, once they get updated with the configuration
transaction that adds the organization to the channel, there will be
only one active leader for the organization. Therefore, it is
recommended to leverage this option if you eventually want the
organization’s peers to utilize leader election.</p>
</div>
</div>
<div class="section" id="install-define-and-invoke-chaincode">
<span id="upgrade-and-invoke"></span><h2>Install, define, and invoke chaincode<a class="headerlink" href="#install-define-and-invoke-chaincode" title="Permalink to this headline">¶</a></h2>
<p>We can confirm that Org3 is a member of <code class="docutils literal notranslate"><span class="pre">channel1</span></code> by installing and invoking
a chaincode on the channel. If the existing channel members have already committed
a chaincode definition to the channel, a new organization can start using the
chaincode by approving the chaincode definition.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These instructions use the Fabric chaincode lifecycle introduced in
the v2.0 release. If you would like to use the previous lifecycle to
install and instantiate a chaincode, visit the v1.4 version of the
<a class="reference external" href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channel_update_tutorial.html">Adding an org to a channel tutorial</a>.</p>
</div>
<p>Before we install a chaincode as Org3, we can use the <code class="docutils literal notranslate"><span class="pre">./network.sh</span></code> script to
deploy the Basic chaincode on the channel. Open a new terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory. You can then use
use the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> script to deploy the Basic chaincode:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> fabric-samples/test-network
./network.sh deployCC -ccn basic -ccp ../asset-transfer-basic/chaincode-go/ -ccl go -c channel1
</pre></div>
</div>
<p>The script will install the Basic chaincode on the Org1 and Org2 peers, approve
the chaincode definition for Org1 and Org2, and then commit the chaincode
definition to the channel. Once the chaincode definition has been committed to
the channel, the Basic chaincode is initialized and invoked to put initial data
on the ledger. The commands below assume that we are still using the channel
<code class="docutils literal notranslate"><span class="pre">channel1</span></code>.</p>
<p>After the chaincode has been to deployed we can use the following steps to use
invoke Basic chaincode as Org3. Copy and paste the following environment
variables in your terminal in order to interact with the network as the Org3
admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span>/../config/
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:11051
</pre></div>
</div>
<p>The first step is to package the Basic chaincode:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode package basic.tar.gz --path ../asset-transfer-basic/chaincode-go/ --lang golang --label basic_1
</pre></div>
</div>
<p>This command will create a chaincode package named <code class="docutils literal notranslate"><span class="pre">basic.tar.gz</span></code>, which we can
install on the Org3 peer. Modify the command accordingly if the channel is running a
chaincode written in Java or Node.js. Issue the following command to install the
chaincode package <code class="docutils literal notranslate"><span class="pre">peer0.org3.example.com</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode install basic.tar.gz
</pre></div>
</div>
<p>The next step is to approve the chaincode definition of Basic as Org3. Org3
needs to approve the same definition that Org1 and Org2 approved and committed
to the channel. In order to invoke the chaincode, Org3 needs to include the
package identifier in the chaincode definition. You can find the package
identifier by querying your peer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode queryinstalled
</pre></div>
</div>
<p>You should see output similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Get installed chaincodes on peer:
Package ID: basic_1:5443b5b557efd3faece8723883d28d6f7026c0bf12245de109b89c5c4fe64887, Label: basic_1
</pre></div>
</div>
<p>We are going to need the package ID in a future command, so lets go ahead and
save it as an environment variable. Paste the package ID returned by the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">queryinstalled</span></code> command into the command below. The
package ID may not be the same for all users, so you need to complete this step
using the package ID returned from your console.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CC_PACKAGE_ID</span><span class="o">=</span>basic_1:5443b5b557efd3faece8723883d28d6f7026c0bf12245de109b89c5c4fe64887
</pre></div>
</div>
<p>Use the following command to approve a definition of the basic chaincode
for Org3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the --package-id flag to provide the package identifier</span>
<span class="c1"># use the --init-required flag to request the ``Init`` function be invoked to initialize the chaincode</span>
peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span> --channelID channel1 --name basic --version <span class="m">1</span>.0 --package-id <span class="nv">$CC_PACKAGE_ID</span> --sequence <span class="m">1</span>
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">querycommitted</span></code> command to check if
the chaincode definition you have approved has already been committed to the
channel.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the --name flag to select the chaincode whose definition you want to query</span>
peer lifecycle chaincode querycommitted --channelID channel1 --name basic --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>A successful command will return information about the committed definition:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Committed chaincode definition <span class="k">for</span> chaincode <span class="s1">&#39;basic&#39;</span> on channel <span class="s1">&#39;channel1&#39;</span>:
Version: <span class="m">1</span>.0, Sequence: <span class="m">1</span>, Endorsement Plugin: escc, Validation Plugin: vscc, Approvals: <span class="o">[</span>Org1MSP: true, Org2MSP: true, Org3MSP: true<span class="o">]</span>
</pre></div>
</div>
<p>Org3 can use the basic chaincode after it approves the chaincode definition
that was committed to the channel. The chaincode definition uses the default endorsement
policy, which requires a majority of organizations on the channel endorse a transaction.
This implies that if an organization is added to or removed from the channel, the
endorsement policy will be updated automatically. We previously needed endorsements
from Org1 and Org2 (2 out of 2). Now we need endorsements from two organizations
out of Org1, Org2, and Org3 (2 out of 3).</p>
<p>Populate the ledger with some sample assets. We’ll get endorsements from the Org2 peer
and the new Org3 peer so that the endorsement policy is satisfied.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span> -C channel1 -n basic --peerAddresses localhost:9051 --tlsRootCertFiles <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt&quot;</span> --peerAddresses localhost:11051 --tlsRootCertFiles <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt&quot;</span> -c <span class="s1">&#39;{&quot;function&quot;:&quot;InitLedger&quot;,&quot;Args&quot;:[]}&#39;</span>
</pre></div>
</div>
<p>You can query the chaincode to ensure that the Org3 peer committed the data.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode query -C channel1 -n basic -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;GetAllAssets&quot;]}&#39;</span>
</pre></div>
</div>
<p>You should see the initial list of assets that were added to the ledger as a
response.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The channel configuration update process is indeed quite involved, but there is a
logical method to the various steps. The endgame is to form a delta transaction object
represented in protobuf binary format and then acquire the requisite number of admin
signatures such that the channel configuration update transaction fulfills the channel’s
modification policy.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> and <code class="docutils literal notranslate"><span class="pre">jq</span></code> tools, along with the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span></code>
commands, provide us with the functionality to accomplish this task.</p>
</div>
<div class="section" id="updating-the-channel-config-to-include-an-org3-anchor-peer-optional">
<h2>Updating the Channel Config to include an Org3 Anchor Peer (Optional)<a class="headerlink" href="#updating-the-channel-config-to-include-an-org3-anchor-peer-optional" title="Permalink to this headline">¶</a></h2>
<p>The Org3 peers were able to establish gossip connection to the Org1 and Org2
peers since Org1 and Org2 had anchor peers defined in the channel configuration.
Likewise newly added organizations like Org3 should also define their anchor peers
in the channel configuration so that any new peers from other organizations can
directly discover an Org3 peer. In this section, we will make a channel
configuration update to define an Org3 anchor peer. The process will be similar
to the previous configuration update, therefore we’ll go faster this time.</p>
<p>As before, we will fetch the latest channel configuration to get started.
Fetch the most recent config block for the channel, using the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch config channel-artifacts/config_block.pb -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com -c channel1 --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>After fetching the config block we will want to convert it into JSON format. To do
this we will use the configtxlator tool, as done previously when adding Org3 to the
channel. First, change into the  <code class="docutils literal notranslate"><span class="pre">channel-artifacts</span></code> folder:</p>
<p>When converting it we need to remove all the headers, metadata, and signatures
that are not required to update Org3 to include an anchor peer by using the <code class="docutils literal notranslate"><span class="pre">jq</span></code>
tool. This information will be reincorporated later before we proceed to update the
channel configuration.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json
jq .data.data<span class="o">[</span><span class="m">0</span><span class="o">]</span>.payload.data.config config_block.json &gt; config.json
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">config.json</span></code> is the now trimmed JSON representing the latest channel configuration
that we will update.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool again, we will update the configuration JSON with the Org3 anchor peer we
want to add.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jq <span class="s1">&#39;.channel_group.groups.Application.groups.Org3MSP.values += {&quot;AnchorPeers&quot;:{&quot;mod_policy&quot;: &quot;Admins&quot;,&quot;value&quot;:{&quot;anchor_peers&quot;: [{&quot;host&quot;: &quot;peer0.org3.example.com&quot;,&quot;port&quot;: 11051}]},&quot;version&quot;: &quot;0&quot;}}&#39;</span> config.json &gt; modified_anchor_config.json
</pre></div>
</div>
<p>We now have two JSON files, one for the current channel configuration,
<code class="docutils literal notranslate"><span class="pre">config.json</span></code>, and one for the desired channel configuration <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.json</span></code>.
Next we convert each of these back into protobuf format and calculate the delta between the two.</p>
<p>Translate <code class="docutils literal notranslate"><span class="pre">config.json</span></code> back into protobuf format as <code class="docutils literal notranslate"><span class="pre">config.pb</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb
</pre></div>
</div>
<p>Translate the <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.json</span></code> into protobuf format as <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.pb</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input modified_anchor_config.json --type common.Config --output modified_anchor_config.pb
</pre></div>
</div>
<p>Calculate the delta between the two protobuf formatted configurations.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator compute_update --channel_id channel1 --original config.pb --updated modified_anchor_config.pb --output anchor_update.pb
</pre></div>
</div>
<p>Now that we have the desired update to the channel we must wrap it in an envelope
message so that it can be properly read. To do this we must first convert the protobuf
back into a JSON that can be wrapped.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> command again to convert <code class="docutils literal notranslate"><span class="pre">anchor_update.pb</span></code> into <code class="docutils literal notranslate"><span class="pre">anchor_update.json</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input anchor_update.pb --type common.ConfigUpdate --output anchor_update.json
</pre></div>
</div>
<p>Next we will wrap the update in an envelope message, restoring the previously
stripped away header, outputting it to <code class="docutils literal notranslate"><span class="pre">anchor_update_in_envelope.json</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;channel1&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;</span><span class="k">$(</span>cat anchor_update.json<span class="k">)</span><span class="s1">&#39;}}}&#39;</span> <span class="p">|</span> jq . &gt; anchor_update_in_envelope.json
</pre></div>
</div>
<p>Now that we have reincorporated the envelope we need to convert it
to a protobuf so it can be properly signed and submitted to the orderer for the update.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input anchor_update_in_envelope.json --type common.Envelope --output anchor_update_in_envelope.pb
</pre></div>
</div>
<p>Now that the update has been properly formatted it is time to sign off and submit it.</p>
<p>Navigate back to the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory:</p>
<p>Since this is only an update to Org3 we only need to have Org3 sign off on the update. Run the following
commands to make sure that we are operating as the Org3 admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:11051
</pre></div>
</div>
<p>We can now just use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">update</span></code> command to sign the update as the
Org3 admin before submitting it to the orderer.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel update -f channel-artifacts/anchor_update_in_envelope.pb -c channel1 -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls --cafile <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span>
</pre></div>
</div>
<p>The orderer receives the config update request and cuts a block with the updated configuration.
As peers receive the block, they will process the configuration updates.</p>
<p>Inspect the logs for one of the peers. While processing the configuration transaction from the new block,
you will see gossip re-establish connections using the new anchor peer for Org3. This is proof
that the configuration update has been successfully applied!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker logs -f peer0.org1.example.com
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2021</span>-01-07 <span class="m">19</span>:07:01.244 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 05a Learning about the configured anchor peers of Org1MSP <span class="k">for</span> channel channel1: <span class="o">[{</span>peer0.org1.example.com <span class="m">7051</span><span class="o">}]</span>
<span class="m">2021</span>-01-07 <span class="m">19</span>:07:01.243 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 05b Learning about the configured anchor peers of Org2MSP <span class="k">for</span> channel channel1: <span class="o">[{</span>peer0.org2.example.com <span class="m">9051</span><span class="o">}]</span>
<span class="m">2021</span>-01-07 <span class="m">19</span>:07:01.244 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 05c Learning about the configured anchor peers of Org3MSP <span class="k">for</span> channel channel1: <span class="o">[{</span>peer0.org3.example.com <span class="m">11051</span><span class="o">}]</span>
</pre></div>
</div>
<p>Congratulations, you have now made two configuration updates — one to add Org3 to the channel,
and a second to define an anchor peer for Org3.</p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="create_channel/channel_policies.html" title="previous page">Channel policies</a>
    <a class='right-next' id="next-link" href="config_update.html" title="next page">Updating a channel configuration</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
  </body>
</html>