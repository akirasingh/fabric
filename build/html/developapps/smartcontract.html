
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Contract Processing &#8212; hyperledger-fabricdocs master documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application" href="application.html" />
    <link rel="prev" title="Process and Data Design" href="architecture.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../index.html">
    
      <p class="title">hyperledger-fabricdocs</p>
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../intro.html">Introduction</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../whatsnew.html">What’s new in Hyperledger Fabric v2.x</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href=""></a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../key_concepts.html">Key Concepts</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting_started.html">Getting Started - Install</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting_started_run_fabric.html">Getting Started - Run Fabric</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="developing_applications.html">Developing Applications</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../tutorials.html">Tutorials</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../deployment_guide_overview.html">Deploying a production network</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../ops_guide.html">Operations Guides</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../upgrade.html">Upgrading to the latest release</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../command_ref.html">Commands Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../architecture.html">Architecture Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../Fabric-FAQ.html">Frequently Asked Questions</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../CONTRIBUTING.html">Contributions Welcome!</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../glossary.html">Glossary</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../releases.html">Releases</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../questions.html">Still Have Questions?</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../status.html">Status</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="scenario.html">The scenario</a>
                </li>
            
          
            
                <li class="">
                    <a href="analysis.html">Analysis</a>
                </li>
            
          
            
                <li class="">
                    <a href="architecture.html">Process and Data Design</a>
                </li>
            
          
            
                <li class="active">
                    <a href="">Smart Contract Processing</a>
                </li>
            
          
            
                <li class="">
                    <a href="application.html">Application</a>
                </li>
            
          
            
                <li class="">
                    <a href="designelements.html">Application design elements</a>
                </li>
            
          
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#smart-contract" class="nav-link">Smart Contract</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#implementation-languages" class="nav-link">Implementation Languages</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#contract-class" class="nav-link">Contract class</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#transaction-definition" class="nav-link">Transaction definition</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#transaction-logic" class="nav-link">Transaction logic</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#representing-an-object" class="nav-link">Representing an object</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#access-the-ledger" class="nav-link">Access the ledger</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="smart-contract-processing">
<h1>Smart Contract Processing<a class="headerlink" href="#smart-contract-processing" title="Permalink to this headline">¶</a></h1>
<p><strong>Audience</strong>: Architects, Application and smart contract developers</p>
<p>At the heart of a blockchain network is a smart contract. In PaperNet, the code
in the commercial paper smart contract defines the valid states for commercial
paper, and the transaction logic that transition a paper from one state to
another. In this topic, we’re going to show you how to implement a real world
smart contract that governs the process of issuing, buying and redeeming
commercial paper.</p>
<p>We’re going to cover:</p>
<ul class="simple">
<li><p><a class="reference external" href="#smart-contract">What is a smart contract and why it’s important</a></p></li>
<li><p><a class="reference external" href="#contract-class">How to define a smart contract</a></p></li>
<li><p><a class="reference external" href="#transaction-definition">How to define a transaction</a></p></li>
<li><p><a class="reference external" href="#transaction-logic">How to implement a transaction</a></p></li>
<li><p><a class="reference external" href="#representing-an-object">How to represent a business object in a smart contract</a></p></li>
<li><p><a class="reference external" href="#access-the-ledger">How to store and retrieve an object in the ledger</a></p></li>
</ul>
<p>If you’d like, you can <a class="reference external" href="../install.html">download the sample</a> and even <a class="reference external" href="../tutorial/commercial_paper.html">run it
locally</a>. It is written in JavaScript and Java, but
the logic is quite language independent, so you’ll easily be able to see what’s
going on! (The sample will become available for Go as well.)</p>
<div class="section" id="smart-contract">
<h2>Smart Contract<a class="headerlink" href="#smart-contract" title="Permalink to this headline">¶</a></h2>
<p>A smart contract defines the different states of a business object and governs
the processes that move the object between these different states. Smart
contracts are important because they allow architects and smart contract
developers to define the key business processes and data that are shared across
the different organizations collaborating in a blockchain network.</p>
<p>In the PaperNet network, the smart contract is shared by the different network
participants, such as MagnetoCorp and DigiBank.  The same version of the smart
contract must be used by all applications connected to the network so that they
jointly implement the same shared business processes and data.</p>
</div>
<div class="section" id="implementation-languages">
<h2>Implementation Languages<a class="headerlink" href="#implementation-languages" title="Permalink to this headline">¶</a></h2>
<p>There are two runtimes that are supported, the Java Virtual Machine and Node.js. This
gives the opportunity to use one of JavaScript, TypeScript, Java or any other language
that can run on one of these supported runtimes.</p>
<p>In Java and TypeScript, annotations or decorators are used to provide information about
the smart contract and its structure. This allows for a richer development experience —
for example, author information or return types can be enforced. Within JavaScript,
conventions must be followed, therefore, there are limitations around what can be
determined automatically.</p>
<p>Examples here are given in both JavaScript and Java.</p>
</div>
<div class="section" id="contract-class">
<h2>Contract class<a class="headerlink" href="#contract-class" title="Permalink to this headline">¶</a></h2>
<p>A copy of the PaperNet commercial paper smart contract is contained in a single
file. View it with your browser, or open it in your favorite editor if you’ve downloaded it.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">papercontract.js</span></code> - <a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/%7BBRANCH%7D/commercial-paper/organization/magnetocorp/contract/lib/papercontract.js">JavaScript version</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CommercialPaperContract.java</span></code> - <a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/%7BBRANCH%7D/commercial-paper/organization/magnetocorp//contract-java/src/main/java/org/example/CommercialPaperContract.java">Java version</a></p></li>
</ul>
<p>You may notice from the file path that this is MagnetoCorp’s copy of the smart
contract.  MagnetoCorp and DigiBank must agree on the version of the smart contract
that they are going to use. For now, it doesn’t matter which organization’s copy
you use, they are all the same.</p>
<p>Spend a few moments looking at the overall structure of the smart contract;
notice that it’s quite short! Towards the top of the file, you’ll see
that there’s a definition for the commercial paper smart contract:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
class CommercialPaperContract extends Contract {...}
```
</details><details>
<summary>Java</summary>
```Java
@Contract(...)
@Default
public class CommercialPaperContract implements ContractInterface {...}
```
</details><p>The <code class="docutils literal notranslate"><span class="pre">CommercialPaperContract</span></code> class contains the transaction definitions for commercial paper – <strong>issue</strong>, <strong>buy</strong>
and <strong>redeem</strong>. It’s these transactions that bring commercial papers into
existence and move them through their lifecycle. We’ll examine these
<a class="reference external" href="#transaction-definition">transactions</a> soon, but for now notice for JavaScript, that the
<code class="docutils literal notranslate"><span class="pre">CommericalPaperContract</span></code> extends the Hyperledger Fabric <code class="docutils literal notranslate"><span class="pre">Contract</span></code>
<a class="reference external" href="https://hyperledger.github.io/fabric-chaincode-node/%7BBRANCH%7D/api/fabric-contract-api.Contract.html">class</a>.</p>
<p>With Java, the class must be decorated with the <code class="docutils literal notranslate"><span class="pre">&#64;Contract(...)</span></code> annotation. This provides the opportunity
to supply additional information about the contract, such as license and author. The <code class="docutils literal notranslate"><span class="pre">&#64;Default()</span></code> annotation
indicates that this contract class is the default contract class. Being able to mark a contract class as the
default contract class is useful in some smart contracts which have multiple contract classes.</p>
<p>If you are using a TypeScript implementation, there are similar <code class="docutils literal notranslate"><span class="pre">&#64;Contract(...)</span></code> annotations that fulfill the same purpose as in Java.</p>
<p>For more information on the available annotations, consult the available API documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://hyperledger.github.io/fabric-chaincode-java/">API documentation for Java smart contracts</a></p></li>
<li><p><a class="reference external" href="https://hyperledger.github.io/fabric-chaincode-node/">API documentation for Node.js smart contracts</a></p></li>
</ul>
<p>The Fabric contract class is also available for smart contracts written in Go. While we do not discuss the Go contract API in this topic, it uses similar concepts as the API for Java and JavaScript:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/hyperledger/fabric-contract-api-go">API documentation for Go smart contracts</a></p></li>
</ul>
<p>These classes, annotations, and the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class, were brought into scope earlier:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
const { Contract, Context } = require('fabric-contract-api');
```
</details><details>
<summary>Java</summary>
```Java
import org.hyperledger.fabric.contract.Context;
import org.hyperledger.fabric.contract.ContractInterface;
import org.hyperledger.fabric.contract.annotation.Contact;
import org.hyperledger.fabric.contract.annotation.Contract;
import org.hyperledger.fabric.contract.annotation.Default;
import org.hyperledger.fabric.contract.annotation.Info;
import org.hyperledger.fabric.contract.annotation.License;
import org.hyperledger.fabric.contract.annotation.Transaction;
```
</details><p>Our commercial paper contract will use built-in features of these classes, such
as automatic method invocation, a
<a class="reference external" href="./transactioncontext.html">per-transaction context</a>,
<a class="reference external" href="./transactionhandler.html">transaction handlers</a>, and class-shared state.</p>
<p>Notice also how the JavaScript class constructor uses its
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/super">superclass</a>
to initialize itself with an explicit <a class="reference external" href="./contractname.html">contract name</a>:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="s1">&#39;org.papernet.commercialpaper&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With the Java class, the constructor is blank as the explicit contract name can be specified in the <code class="docutils literal notranslate"><span class="pre">&#64;Contract()</span></code> annotation. If it’s absent, then the name of the class is used.</p>
<p>Most importantly, <code class="docutils literal notranslate"><span class="pre">org.papernet.commercialpaper</span></code> is very descriptive – this smart
contract is the agreed definition of commercial paper for all PaperNet
organizations.</p>
<p>Usually there will only be one smart contract per file – contracts tend to have
different lifecycles, which makes it sensible to separate them. However, in some
cases, multiple smart contracts might provide syntactic help for applications,
e.g. <code class="docutils literal notranslate"><span class="pre">EuroBond</span></code>, <code class="docutils literal notranslate"><span class="pre">DollarBond</span></code>, <code class="docutils literal notranslate"><span class="pre">YenBond</span></code>, but essentially provide the same
function. In such cases, smart contracts and transactions can be disambiguated.</p>
</div>
<div class="section" id="transaction-definition">
<h2>Transaction definition<a class="headerlink" href="#transaction-definition" title="Permalink to this headline">¶</a></h2>
<p>Within the class, locate the <strong>issue</strong> method.</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
async issue(ctx, issuer, paperNumber, issueDateTime, maturityDateTime, faceValue) {...}
```
</details><details>
<summary>Java</summary>
```Java
@Transaction
public CommercialPaper issue(CommercialPaperContext ctx,
                             String issuer,
                             String paperNumber,
                             String issueDateTime,
                             String maturityDateTime,
                             int faceValue) {...}
```
</details><p>The Java annotation <code class="docutils literal notranslate"><span class="pre">&#64;Transaction</span></code> is used to mark this method as a transaction definition; TypeScript has an equivalent annotation.</p>
<p>This function is given control whenever this contract is called to <code class="docutils literal notranslate"><span class="pre">issue</span></code> a
commercial paper. Recall how commercial paper 00001 was created with the
following transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">issue</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Issue</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Maturity</span> <span class="n">date</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">November</span> <span class="mi">2020</span>
<span class="n">Face</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<p>We’ve changed the variable names for programming style, but see how these
properties map almost directly to the <code class="docutils literal notranslate"><span class="pre">issue</span></code> method variables.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">issue</span></code> method is automatically given control by the contract whenever an
application makes a request to issue a commercial paper. The transaction
property values are made available to the method via the corresponding
variables. See how an application submits a transaction using the Hyperledger
Fabric SDK in the <a class="reference external" href="./application.html">application</a> topic, using a sample
application program.</p>
<p>You might have noticed an extra variable in the <strong>issue</strong> definition – <code class="docutils literal notranslate"><span class="pre">ctx</span></code>.
It’s called the <a class="reference external" href="./transactioncontext.html"><strong>transaction context</strong></a>, and it’s
always first. By default, it maintains both per-contract and per-transaction
information relevant to <a class="reference external" href="#transaction-logic">transaction logic</a>. For example, it
would contain MagnetoCorp’s specified transaction identifier, a MagnetoCorp
issuing user’s digital certificate, as well as access to the ledger API.</p>
<p>See how the smart contract extends the default transaction context by
implementing its own <code class="docutils literal notranslate"><span class="pre">createContext()</span></code> method rather than accepting the
default implementation:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
createContext() {
  return new CommercialPaperContext()
}
```
</details><details>
<summary>Java</summary>
```Java
@Override
public Context createContext(ChaincodeStub stub) {
     return new CommercialPaperContext(stub);
}
```
</details><p>This extended context adds a custom property <code class="docutils literal notranslate"><span class="pre">paperList</span></code> to the defaults:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
class CommercialPaperContext extends Context {<p>constructor() {
super();
// All papers are held in a list of papers
this.paperList = new PaperList(this);
}</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;/details&gt;

&lt;details&gt;
&lt;summary&gt;Java&lt;/summary&gt;
```Java
class CommercialPaperContext extends Context {
    public CommercialPaperContext(ChaincodeStub stub) {
        super(stub);
        this.paperList = new PaperList(this);
    }
    public PaperList paperList;
}
</pre></div>
</div>
</details><p>We’ll soon see how <code class="docutils literal notranslate"><span class="pre">ctx.paperList</span></code> can be subsequently used to help store and
retrieve all PaperNet commercial papers.</p>
<p>To solidify your understanding of the structure of a smart contract transaction,
locate the <strong>buy</strong> and <strong>redeem</strong> transaction definitions, and see if you can
see how they map to their corresponding commercial paper transactions.</p>
<p>The <strong>buy</strong> transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">buy</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Current</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">New</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">DigiBank</span>
<span class="n">Purchase</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Price</span> <span class="o">=</span> <span class="mf">4.94</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
async buy(ctx, issuer, paperNumber, currentOwner, newOwner, price, purchaseTime) {...}
```
</details><details>
<summary>Java</summary>
```Java
@Transaction
public CommercialPaper buy(CommercialPaperContext ctx,
                           String issuer,
                           String paperNumber,
                           String currentOwner,
                           String newOwner,
                           int price,
                           String purchaseDateTime) {...}
```
</details><p>The <strong>redeem</strong> transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">redeem</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Redeemer</span> <span class="o">=</span> <span class="n">DigiBank</span>
<span class="n">Redeem</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">Dec</span> <span class="mi">2020</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
</pre></div>
</div>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
async redeem(ctx, issuer, paperNumber, redeemingOwner, redeemDateTime) {...}
```
</details><details>
<summary>Java</summary>
```Java
@Transaction
public CommercialPaper redeem(CommercialPaperContext ctx,
                              String issuer,
                              String paperNumber,
                              String redeemingOwner,
                              String redeemDateTime) {...}
```
</details><p>In both cases, observe the 1:1 correspondence between the commercial paper
transaction and the smart contract method definition.</p>
<p>All of the JavaScript functions use the <code class="docutils literal notranslate"><span class="pre">async</span></code> and <code class="docutils literal notranslate"><span class="pre">await</span></code>
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">keywords</a> which allow JavaScript functions to be treated as if they were synchronous function calls.</p>
</div>
<div class="section" id="transaction-logic">
<h2>Transaction logic<a class="headerlink" href="#transaction-logic" title="Permalink to this headline">¶</a></h2>
<p>Now that you’ve seen how contracts are structured and transactions are defined,
let’s focus on the logic within the smart contract.</p>
<p>Recall the first <strong>issue</strong> transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Txn</span> <span class="o">=</span> <span class="n">issue</span>
<span class="n">Issuer</span> <span class="o">=</span> <span class="n">MagnetoCorp</span>
<span class="n">Paper</span> <span class="o">=</span> <span class="mi">00001</span>
<span class="n">Issue</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">31</span> <span class="n">May</span> <span class="mi">2020</span> <span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">EST</span>
<span class="n">Maturity</span> <span class="n">date</span> <span class="o">=</span> <span class="mi">30</span> <span class="n">November</span> <span class="mi">2020</span>
<span class="n">Face</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="n">M</span> <span class="n">USD</span>
</pre></div>
</div>
<p>It results in the <strong>issue</strong> method being passed control:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
async issue(ctx, issuer, paperNumber, issueDateTime, maturityDateTime, faceValue) {<p>// create an instance of the paper
let paper = CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime, faceValue);</p>
<p>// Smart contract, rather than paper, moves paper into ISSUED state
paper.setIssued();</p>
<p>// Newly issued paper is owned by the issuer
paper.setOwner(issuer);</p>
<p>// Add the paper to the list of all similar commercial papers in the ledger world state
await ctx.paperList.addPaper(paper);</p>
<p>// Must return a serialized paper to caller of smart contract
return paper.toBuffer();
}</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;/details&gt;

&lt;details&gt;
&lt;summary&gt;Java&lt;/summary&gt;
```Java
@Transaction
public CommercialPaper issue(CommercialPaperContext ctx,
                              String issuer,
                              String paperNumber,
                              String issueDateTime,
                              String maturityDateTime,
                              int faceValue) {

    System.out.println(ctx);

    // create an instance of the paper
    CommercialPaper paper = CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime,
            faceValue,issuer,&quot;&quot;);

    // Smart contract, rather than paper, moves paper into ISSUED state
    paper.setIssued();

    // Newly issued paper is owned by the issuer
    paper.setOwner(issuer);

    System.out.println(paper);
    // Add the paper to the list of all similar commercial papers in the ledger
    // world state
    ctx.paperList.addPaper(paper);

    // Must return a serialized paper to caller of smart contract
    return paper;
}
</pre></div>
</div>
</details><p>The logic is simple: take the transaction input variables, create a new
commercial paper <code class="docutils literal notranslate"><span class="pre">paper</span></code>, add it to the list of all commercial papers using
<code class="docutils literal notranslate"><span class="pre">paperList</span></code>, and return the new commercial paper (serialized as a buffer) as the
transaction response.</p>
<p>See how <code class="docutils literal notranslate"><span class="pre">paperList</span></code> is retrieved from the transaction context to provide access
to the list of commercial papers. <code class="docutils literal notranslate"><span class="pre">issue()</span></code>, <code class="docutils literal notranslate"><span class="pre">buy()</span></code> and <code class="docutils literal notranslate"><span class="pre">redeem()</span></code> continually
re-access <code class="docutils literal notranslate"><span class="pre">ctx.paperList</span></code> to keep the list of commercial papers up-to-date.</p>
<p>The logic for the <strong>buy</strong> transaction is a little more elaborate:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
async buy(ctx, issuer, paperNumber, currentOwner, newOwner, price, purchaseDateTime) {<p>// Retrieve the current paper using key fields provided
let paperKey = CommercialPaper.makeKey([issuer, paperNumber]);
let paper = await ctx.paperList.getPaper(paperKey);</p>
<p>// Validate current owner
if (paper.getOwner() !== currentOwner) {
throw new Error(‘Paper ‘ + issuer + paperNumber + ‘ is not owned by ‘ + currentOwner);
}</p>
<p>// First buy moves state from ISSUED to TRADING
if (paper.isIssued()) {
paper.setTrading();
}</p>
<p>// Check paper is not already REDEEMED
if (paper.isTrading()) {
paper.setOwner(newOwner);
} else {
throw new Error(‘Paper ‘ + issuer + paperNumber + ‘ is not trading. Current state = ‘ +paper.getCurrentState());
}</p>
<p>// Update the paper
await ctx.paperList.updatePaper(paper);
return paper.toBuffer();
}</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;/details&gt;

&lt;details&gt;
&lt;summary&gt;Java&lt;/summary&gt;
```Java
@Transaction
public CommercialPaper buy(CommercialPaperContext ctx,
                           String issuer,
                           String paperNumber,
                           String currentOwner,
                           String newOwner,
                           int price,
                           String purchaseDateTime) {

    // Retrieve the current paper using key fields provided
    String paperKey = State.makeKey(new String[] { paperNumber });
    CommercialPaper paper = ctx.paperList.getPaper(paperKey);

    // Validate current owner
    if (!paper.getOwner().equals(currentOwner)) {
        throw new RuntimeException(&quot;Paper &quot; + issuer + paperNumber + &quot; is not owned by &quot; + currentOwner);
    }

    // First buy moves state from ISSUED to TRADING
    if (paper.isIssued()) {
        paper.setTrading();
    }

    // Check paper is not already REDEEMED
    if (paper.isTrading()) {
        paper.setOwner(newOwner);
    } else {
        throw new RuntimeException(
                &quot;Paper &quot; + issuer + paperNumber + &quot; is not trading. Current state = &quot; + paper.getState());
    }

    // Update the paper
    ctx.paperList.updatePaper(paper);
    return paper;
}
</pre></div>
</div>
</details><p>See how the transaction checks <code class="docutils literal notranslate"><span class="pre">currentOwner</span></code> and that <code class="docutils literal notranslate"><span class="pre">paper</span></code> is <code class="docutils literal notranslate"><span class="pre">TRADING</span></code>
before changing the owner with <code class="docutils literal notranslate"><span class="pre">paper.setOwner(newOwner)</span></code>. The basic flow is
simple though – check some pre-conditions, set the new owner, update the
commercial paper on the ledger, and return the updated commercial paper
(serialized as a buffer) as the transaction response.</p>
<p>Why don’t you see if you can understand the logic for the <strong>redeem</strong>
transaction?</p>
</div>
<div class="section" id="representing-an-object">
<h2>Representing an object<a class="headerlink" href="#representing-an-object" title="Permalink to this headline">¶</a></h2>
<p>We’ve seen how to define and implement the <strong>issue</strong>, <strong>buy</strong> and <strong>redeem</strong>
transactions using the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> and <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> classes. Let’s end
this topic by seeing how these classes work.</p>
<p>Locate the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class:</p>
<details open="true">
<summary>JavaScript</summary>
In the
[paper.js file](https://github.com/hyperledger/fabric-samples/blob/{BRANCH}/commercial-paper/organization/magnetocorp/contract/lib/paper.js):<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nx">CommercialPaper</span> <span class="k">extends</span> <span class="nx">State</span> <span class="p">{...}</span>
</pre></div>
</div>
</details><details>
<summary>Java</summary>
In the [CommercialPaper.java file](https://github.com/hyperledger/fabric-samples/blob/release-1.4/commercial-paper/organization/magnetocorp/contract-java/src/main/java/org/example/CommercialPaper.java):<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="nd">@DataType</span><span class="p">()</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommercialPaper</span> <span class="kd">extends</span> <span class="n">State</span> <span class="p">{...}</span>
</pre></div>
</div>
</details><p>This class contains the in-memory representation of a commercial paper state.
See how the <code class="docutils literal notranslate"><span class="pre">createInstance</span></code> method initializes a new commercial paper with the
provided parameters:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
static createInstance(issuer, paperNumber, issueDateTime, maturityDateTime, faceValue) {
  return new CommercialPaper({ issuer, paperNumber, issueDateTime, maturityDateTime, faceValue });
}
```
</details><details>
<summary>Java</summary>
```Java
public static CommercialPaper createInstance(String issuer, String paperNumber, String issueDateTime,
        String maturityDateTime, int faceValue, String owner, String state) {
    return new CommercialPaper().setIssuer(issuer).setPaperNumber(paperNumber).setMaturityDateTime(maturityDateTime)
            .setFaceValue(faceValue).setKey().setIssueDateTime(issueDateTime).setOwner(owner).setState(state);
}
```
</details><p>Recall how this class was used by the <strong>issue</strong> transaction:</p>
<details open="true">
<summary>JavaScript</summary>
```JavaScript
let paper = CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime, faceValue);
```
</details><details>
<summary>Java</summary>
```Java
CommercialPaper paper = CommercialPaper.createInstance(issuer, paperNumber, issueDateTime, maturityDateTime,
        faceValue,issuer,"");
```
</details><p>See how every time the issue transaction is called, a new in-memory instance of
a commercial paper is created containing the transaction data.</p>
<p>A few important points to note:</p>
<ul>
<li><p>This is an in-memory representation; we’ll see
<a class="reference external" href="#accessing-the-ledger">later</a> how it appears on the ledger.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class extends the <code class="docutils literal notranslate"><span class="pre">State</span></code> class. <code class="docutils literal notranslate"><span class="pre">State</span></code> is an
application-defined class which creates a common abstraction for a state.
All states have a business object class which they represent, a composite
key, can be serialized and de-serialized, and so on.  <code class="docutils literal notranslate"><span class="pre">State</span></code> helps our code
be more legible when we are storing more than one business object type on
the ledger. Examine the <code class="docutils literal notranslate"><span class="pre">State</span></code> class in the <code class="docutils literal notranslate"><span class="pre">state.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/%7BBRANCH%7D/commercial-paper/organization/magnetocorp/contract/ledger-api/state.js">file</a>.</p></li>
<li><p>A paper computes its own key when it is created – this key will be used
when the ledger is accessed. The key is formed from a combination of
<code class="docutils literal notranslate"><span class="pre">issuer</span></code> and <code class="docutils literal notranslate"><span class="pre">paperNumber</span></code>.</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">constructor</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">super</span><span class="p">(</span><span class="nx">CommercialPaper</span><span class="p">.</span><span class="nx">getClass</span><span class="p">(),</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">issuer</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">paperNumber</span><span class="p">]);</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>A paper is moved to the <code class="docutils literal notranslate"><span class="pre">ISSUED</span></code> state by the transaction, not by the paper
class. That’s because it’s the smart contract that governs the lifecycle
state of the paper. For example, an <code class="docutils literal notranslate"><span class="pre">import</span></code> transaction might create a new
set of papers immediately in the <code class="docutils literal notranslate"><span class="pre">TRADING</span></code> state.</p></li>
</ul>
<p>The rest of the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class contains simple helper methods:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="nx">getOwner</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">owner</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall how methods like this were used by the smart contract to move the
commercial paper through its lifecycle. For example, in the <strong>redeem</strong>
transaction we saw:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getOwner</span><span class="p">()</span> <span class="o">===</span> <span class="nx">redeemingOwner</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setOwner</span><span class="p">(</span><span class="nx">paper</span><span class="p">.</span><span class="nx">getIssuer</span><span class="p">());</span>
  <span class="nx">paper</span><span class="p">.</span><span class="nx">setRedeemed</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="access-the-ledger">
<h2>Access the ledger<a class="headerlink" href="#access-the-ledger" title="Permalink to this headline">¶</a></h2>
<p>Now locate the <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> class in the <code class="docutils literal notranslate"><span class="pre">paperlist.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/%7BBRANCH%7D/commercial-paper/organization/magnetocorp/contract/lib/paperlist.js">file</a>:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nx">PaperList</span> <span class="k">extends</span> <span class="nx">StateList</span> <span class="p">{</span>
</pre></div>
</div>
<p>This utility class is used to manage all PaperNet commercial papers in
Hyperledger Fabric state database. The PaperList data structures are described
in more detail in the <a class="reference external" href="./architecture.html">architecture topic</a>.</p>
<p>Like the <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code> class, this class extends an application-defined
<code class="docutils literal notranslate"><span class="pre">StateList</span></code> class which creates a common abstraction for a list of states – in
this case, all the commercial papers in PaperNet.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">addPaper()</span></code> method is a simple veneer over the <code class="docutils literal notranslate"><span class="pre">StateList.addState()</span></code>
method:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="nx">addPaper</span><span class="p">(</span><span class="nx">paper</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">addState</span><span class="p">(</span><span class="nx">paper</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can see in the <code class="docutils literal notranslate"><span class="pre">StateList.js</span></code>
<a class="reference external" href="https://github.com/hyperledger/fabric-samples/blob/%7BBRANCH%7D/commercial-paper/organization/magnetocorp/contract/ledger-api/statelist.js">file</a>
how the <code class="docutils literal notranslate"><span class="pre">StateList</span></code> class uses the Fabric API <code class="docutils literal notranslate"><span class="pre">putState()</span></code> to write the
commercial paper as state data in the ledger:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="nx">addState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">getSplitKey</span><span class="p">());</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">putState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Every piece of state data in a ledger requires these two fundamental elements:</p>
<ul class="simple">
<li><p><strong>Key</strong>: <code class="docutils literal notranslate"><span class="pre">key</span></code> is formed with <code class="docutils literal notranslate"><span class="pre">createCompositeKey()</span></code> using a fixed name and
the key of <code class="docutils literal notranslate"><span class="pre">state</span></code>. The name was assigned when the <code class="docutils literal notranslate"><span class="pre">PaperList</span></code> object was
constructed, and <code class="docutils literal notranslate"><span class="pre">state.getSplitKey()</span></code> determines each state’s unique key.</p></li>
<li><p><strong>Data</strong>: <code class="docutils literal notranslate"><span class="pre">data</span></code> is simply the serialized form of the commercial paper
state, created using the <code class="docutils literal notranslate"><span class="pre">State.serialize()</span></code> utility method. The <code class="docutils literal notranslate"><span class="pre">State</span></code>
class serializes and deserializes data using JSON, and the State’s business
object class as required, in our case <code class="docutils literal notranslate"><span class="pre">CommercialPaper</span></code>, again set when the
<code class="docutils literal notranslate"><span class="pre">PaperList</span></code> object was constructed.</p></li>
</ul>
<p>Notice how a <code class="docutils literal notranslate"><span class="pre">StateList</span></code> doesn’t store anything about an individual state or the
total list of states – it delegates all of that to the Fabric state database.
This is an important design pattern – it reduces the opportunity for <a class="reference external" href="../readwrite.html">ledger
MVCC collisions</a> in Hyperledger Fabric.</p>
<p>The StateList <code class="docutils literal notranslate"><span class="pre">getState()</span></code> and <code class="docutils literal notranslate"><span class="pre">updateState()</span></code> methods work in similar ways:</p>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">ledgerKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">State</span><span class="p">.</span><span class="nx">splitKey</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">getState</span><span class="p">(</span><span class="nx">ledgerKey</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">supportedClasses</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-JavaScript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="nx">updateState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">createCompositeKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">getSplitKey</span><span class="p">());</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">State</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">stub</span><span class="p">.</span><span class="nx">putState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how they use the Fabric APIs <code class="docutils literal notranslate"><span class="pre">putState()</span></code>, <code class="docutils literal notranslate"><span class="pre">getState()</span></code> and
<code class="docutils literal notranslate"><span class="pre">createCompositeKey()</span></code> to access the ledger. We’ll expand this smart contract
later to list all commercial papers in paperNet – what might the method look
like to implement this ledger retrieval?</p>
<p>That’s it! In this topic you’ve understood how to implement the smart contract
for PaperNet.  You can move to the next sub topic to see how an application
calls the smart contract using the Fabric SDK.</p>
<!--- Licensed under Creative Commons Attribution 4.0 International License
https://creativecommons.org/licenses/by/4.0/ --></div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="architecture.html" title="previous page">Process and Data Design</a>
    <a class='right-next' id="next-link" href="application.html" title="next page">Application</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
  </body>
</html>